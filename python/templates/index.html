<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PROMPTOON</title>
  <link
    href="data:image/x-icon;base64,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"
    rel="icon" type="image/x-icon" />
  <link rel="shortcut icon"
    href="data:image/x-icon;base64,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"
    type="image/x-icon" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
  <header>
    <h1>PROMPTOON</h1>
    <p class="subtitle">ä¸Šä¼ å›¾ç‰‡,è‡ªåŠ¨åæ¨ç”Ÿæˆ AI ç»˜ç”»æç¤ºè¯</p>
    <!-- å½“å‰æ¨¡å‹æ˜¾ç¤º -->
    <div class="current-model-display" id="currentModelDisplay">å½“å‰æ¨¡å‹: æ— </div>
    <!-- APIè®¾ç½®æŒ‰é’® -->
    <button class="header-btn records-btn" id="savedRecordsBtn">ğŸ“‹</button>
    <div class="header-btn settings-btn" id="apiSettingsBtn">âš™ï¸</div>
  </header>

  <div class="container">
    <div class="main-layout" id="mainLayout">
      <div class="upload-section">
        <div class="upload-area" id="uploadArea">
          <div class="upload-content">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
            <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼</div>
          </div>
          <div class="preview-image-wrapper">
            <img id="previewImage" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
            <div class="loading" id="loading">
              <div class="spinner"></div>
              <p>æ­£åœ¨åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆæç¤ºè¯...</p>
            </div>
          </div>
          <input type="file" id="fileInput" accept="image/*">
        </div>
        <button class="btn" id="generateBtn" disabled>ç”Ÿæˆæç¤ºè¯</button>
      </div>
      <!-- æ¶ˆæ¯å¼¹çª— -->
      <div class="message-modal" id="messageModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title" id="modalTitle">æç¤º</span>
          </div>
          <div class="modal-body">
            <p id="modalMessage"></p>
          </div>
        </div>
      </div>
      <!-- APIè®¾ç½®å¼¹çª— -->
      <div class="modal" id="apiSettingsModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title">APIè®¾ç½®</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="aiModel">AIæ¨¡å‹:
                <button id="manageModelsBtn" class="btn btn-secondary"
                  style="float: right; padding: 4px 8px; font-size: 0.8rem;">ç®¡ç†æ¨¡å‹</button>
              </label>
              <select id="aiModel" class="form-control">
                <option value="gemini">GEMINI</option>
                <option value="doubao">è±†åŒ…</option>
              </select>
            </div>

            <div class="form-group">
              <label for="modelVersion">æ¨¡å‹ç‰ˆæœ¬:</label>
              <select id="modelVersion" class="form-control">
              </select>
            </div>

            <div class="form-group">
              <label for="apiKey">API Key:</label>
              <input type="password" id="apiKey" class="form-control" placeholder="è¯·è¾“å…¥API Key">
            </div>

            <div class="form-actions">
              <button id="saveApiSettings" class="btn">ä¿å­˜</button>
              <button id="cancelApiSettings" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- æ¨¡å‹ç®¡ç†å¼¹çª— -->
      <div class="modal" id="modelManagementModal">
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <span class="modal-title">æ¨¡å‹ç®¡ç†</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>å½“å‰æ¨¡å‹åˆ—è¡¨:</label>
              <div id="modelListContainer">
                <!-- æ¨¡å‹åˆ—è¡¨ -->
              </div>
            </div>
            <div class="form-group">
              <label>ä¸ºé€‰ä¸­æ¨¡å‹æ·»åŠ ç‰ˆæœ¬:</label>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <select id="modelSelector" class="form-control" style="flex: 1;">
                  <!-- æ¨¡å‹é€‰é¡¹ -->
                </select>
                <input type="text" id="newVersionValue" class="form-control"
                  placeholder="ç‰ˆæœ¬å€¼ (å¦‚: gemini-2.5-flash-lite)" style="flex: 1;">
                <input type="text" id="newVersionText" class="form-control" placeholder="ç‰ˆæœ¬æ˜¾ç¤ºæ–‡æœ¬" style="flex: 1;">
                <button id="addVersionBtn" class="model-btn">æ·»åŠ ç‰ˆæœ¬</button>
              </div>
            </div>

            <div class="form-actions">
              <button id="resetModelsBtn" class="btn btn-secondary">æ¢å¤é»˜è®¤</button>
              <button id="saveModelsBtn" class="btn">ä¿å­˜</button>
              <button id="cancelModelManagement" class="btn btn-secondary">å…³é—­</button>
            </div>
          </div>
        </div>
      </div>

      <div class="result-section" id="resultSection">
        <div class="save-action-bar">
          <button class="btn btn-save" id="saveRecordBtn">ä¿å­˜è®°å½•</button>
        </div>
        <div class="tab-container">
          <div class="tab-buttons">
            <button class="tab-btn active" data-tab="cn">ä¸­æ–‡æç¤ºè¯</button>
            <button class="tab-btn" data-tab="en">English Prompt</button>
          </div>
          <div class="tab-content active" id="cnTab">
            <div class="prompt-card">
              <h3>
                ä¸­æ–‡æç¤ºè¯
              </h3>
              <div class="prompt-card-content" id="chinesePromptDetails"></div>
              <div class="full-prompt-box">
                <div class="prompt-label full">å®Œæ•´æè¿°</div>
                <textarea class="full-prompt-text" id="fullPromptCn"></textarea>
                <button class="copy-btn" onclick="copyFullPrompt('fullPromptCn', this)">å¤åˆ¶</button>
              </div>
            </div>
          </div>
          <div class="tab-content" id="enTab">
            <div class="prompt-card">
              <h3>
                English Prompt
              </h3>
              <div class="prompt-card-content" id="englishPromptDetails"></div>
              <div class="full-prompt-box">
                <div class="prompt-label full">å®Œæ•´æç¤ºè¯</div>
                <textarea class="full-prompt-text" id="fullPromptEn"></textarea>
                <button class="copy-btn" onclick="copyFullPrompt('fullPromptEn', this)">å¤åˆ¶</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ç¡®è®¤å¼¹çª— -->
    <div class="modal confirm-modal" id="confirmModal">
      <div class="confirm-modal-content">
        <div class="confirm-modal-body">
          <div class="confirm-modal-message" id="confirmMessage"></div>
          <div class="confirm-modal-actions">
            <button class="confirm-btn secondary" id="confirmCancel">å–æ¶ˆ</button>
            <button class="confirm-btn primary" id="confirmOk">ç¡®å®š</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal" id="savedRecordsModal">
      <div class="modal-content"
        style="max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
        <div class="modal-header">
          <span class="modal-title">å·²ä¿å­˜è®°å½•</span>
          <button class="close-modal-btn" id="closeSavedRecordsModal">âœ•</button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
          <div id="savedRecordsList"></div>
          <div id="emptyRecordsHint" style="text-align: center; color: #86868b; padding: 40px; display: none;">
            æš‚æ— ä¿å­˜è®°å½•
          </div>
        </div>
      </div>
    </div>

    <!-- è®°å½•è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="recordDetailModal">
      <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
          <span class="modal-title">è®°å½•è¯¦æƒ…</span>
          <button class="close-modal-btn" id="closeRecordDetailModal">âœ•</button>
        </div>
        <div class="modal-body">
          <div id="recordDetailContent"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const generateBtn = document.getElementById('generateBtn');
    const previewImage = document.getElementById('previewImage');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const mainLayout = document.getElementById('mainLayout');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const manageModelsBtn = document.getElementById('manageModelsBtn');
    const modelManagementModal = document.getElementById('modelManagementModal');
    const cancelModelManagement = document.getElementById('cancelModelManagement');
    const addVersionBtn = document.getElementById('addVersionBtn');
    const saveModelsBtn = document.getElementById('saveModelsBtn');
    const resetModelsBtn = document.getElementById('resetModelsBtn');
    const modelListContainer = document.getElementById('modelListContainer');
    const modelSelector = document.getElementById('modelSelector');
    const apiSettingsBtn = document.getElementById('apiSettingsBtn');
    const apiSettingsModal = document.getElementById('apiSettingsModal');
    const cancelApiSettings = document.getElementById('cancelApiSettings');
    const aiModelSelect = document.getElementById('aiModel');
    const modelVersionSelect = document.getElementById('modelVersion');
    const saveApiSettings = document.getElementById('saveApiSettings');
    const savedRecordsBtn = document.getElementById('savedRecordsBtn')
    const saveRecordBtn = document.getElementById('saveRecordBtn')
    let currentCompressedImage = null;
    let currentPromptData = null;
    const DB_NAME = 'PromptoonDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'savedRecords';

    // é»˜è®¤æ¨¡å‹é…ç½®
    const defaultModels = [
      {
        id: 'gemini',
        name: 'GEMINI',
        apiKey: '',
        versions: [
          { value: 'gemini-2.5-flash-lite', text: 'gemini-2.5-flash-lite' },
          { value: 'gemini-3.0-pro', text: 'gemini-3.0-pro' }
        ]
      },
      {
        id: 'doubao',
        name: 'è±†åŒ…',
        apiKey: '',
        versions: [
          { value: 'doubao-seed-1-8-251228', text: 'Doubao-Seed-1.8' },
          { value: 'doubao-seed-1-6-lite-251015', text: 'Doubao-Seed-1.6-Lite' },
        ]
      }
    ];

    let currentModels = [];
    let selectedFile = null;
    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = () => reject(request.error);
        request.onsuccess = () => resolve(request.result);

        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_NAME)) {
            const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
            objectStore.createIndex('timestamp', 'timestamp', { unique: false });
          }
        };
      });
    }
    async function saveRecordToDB(record) {
      const db = await initIndexedDB();
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const objectStore = transaction.objectStore(STORE_NAME);

      return new Promise((resolve, reject) => {
        const request = objectStore.add(record);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    async function getAllRecords() {
      const db = await initIndexedDB();
      const transaction = db.transaction([STORE_NAME], 'readonly');
      const objectStore = transaction.objectStore(STORE_NAME);

      return new Promise((resolve, reject) => {
        const request = objectStore.getAll();
        request.onsuccess = () => {
          const records = request.result;
          // æŒ‰æ—¶é—´å€’åºæ’åº
          records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          resolve(records);
        };
        request.onerror = () => reject(request.error);
      });
    }
    async function deleteRecord(id) {
      const db = await initIndexedDB();
      const transaction = db.transaction([STORE_NAME], 'readwrite');
      const objectStore = transaction.objectStore(STORE_NAME);

      return new Promise((resolve, reject) => {
        const request = objectStore.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }
    function displaySavedRecords(records) {
      const container = document.getElementById('savedRecordsList');
      const emptyHint = document.getElementById('emptyRecordsHint');

      if (records.length === 0) {
        container.innerHTML = '';
        emptyHint.style.display = 'block';
        return;
      }

      emptyHint.style.display = 'none';
      container.innerHTML = records.map(record => `
    <div class="record-item" data-id="${record.id}">
      <img src="data:image/jpeg;base64,${record.imageBase64}" alt="ä¿å­˜çš„å›¾ç‰‡" class="record-thumbnail">
      <div class="record-info">
        <div class="record-time">${new Date(record.timestamp).toLocaleString('zh-CN')}</div>
        <div class="record-preview">
          ${record.promptData.chinese_prompt?.subject?.substring(0, 50) || 'æ— ä¸»é¢˜æè¿°'}...
        </div>
      </div>
      <div class="record-actions">
        <button class="btn-small btn-view" onclick="viewRecordDetail(${record.id})">æŸ¥çœ‹è¯¦æƒ…</button>
        <button class="btn-small btn-delete" onclick="deleteRecordItem(${record.id})">åˆ é™¤</button>
      </div>
    </div>
  `).join('');
    }
    window.viewRecordDetail = async function (id) {
      try {
        const records = await getAllRecords();
        const record = records.find(r => r.id === id);

        if (!record) {
          showMessage('è®°å½•ä¸å­˜åœ¨', 'é”™è¯¯', 2000);
          return;
        }
        const detailContent = document.getElementById('recordDetailContent');
        detailContent.innerHTML = `
      <div class="detail-image-container">
        <img src="data:image/jpeg;base64,${record.imageBase64}" alt="å›¾ç‰‡" class="detail-image">
      </div>
      <div class="detail-time">ä¿å­˜æ—¶é—´: ${new Date(record.timestamp).toLocaleString('zh-CN')}</div>
      
      <div class="detail-prompts">
        <div class="detail-section">
          <h4>ä¸­æ–‡æç¤ºè¯</h4>
          <div class="prompt-fields-detail">
            ${generatePromptFields(record.promptData.chinese_prompt, 'cn')}
          </div>
          <div class="full-prompt-box">
            <div class="prompt-label full">å®Œæ•´æè¿°</div>
            <textarea class="full-prompt-text" id="detailFullPromptCn" readonly>${generateFullPrompt(record.promptData.chinese_prompt, 'cn')}</textarea>
            <button class="copy-btn" onclick="copyFullPrompt('detailFullPromptCn', this)">å¤åˆ¶</button>
          </div>
        </div>
        
        <div class="detail-section">
          <h4>English Prompt</h4>
          <div class="prompt-fields-detail">
            ${generatePromptFields(record.promptData.english_prompt, 'en')}
          </div>
          <div class="full-prompt-box">
            <div class="prompt-label full">å®Œæ•´æç¤ºè¯</div>
            <textarea class="full-prompt-text" id="detailFullPromptEn" readonly>${generateFullPrompt(record.promptData.english_prompt, 'en')}</textarea>
            <button class="copy-btn" onclick="copyFullPrompt('detailFullPromptEn', this)">å¤åˆ¶</button>
          </div>
        </div>
      </div>
    `;

        // æ˜¾ç¤ºå¼¹çª—å‰ç¡®ä¿åœ¨å¯è§†åŒºåŸŸ
        const modal = document.getElementById('recordDetailModal');
        modal.style.display = 'block';

        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        modal.scrollTop = 0;

      } catch (error) {
        showMessage('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + error.message, 'é”™è¯¯', 3000);
      }
    };
    // åˆ é™¤è®°å½•
    window.deleteRecordItem = async function (id) {
      const confirmed = await showConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—?');
      if (!confirmed) return;

      try {
        await deleteRecord(id);
        const records = await getAllRecords();
        displaySavedRecords(records);
        showMessage('åˆ é™¤æˆåŠŸ', 'æˆåŠŸ', 2000);
      } catch (error) {
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'é”™è¯¯', 3000);
      }
    };
    document.getElementById('closeSavedRecordsModal').addEventListener('click', () => {
      document.getElementById('savedRecordsModal').style.display = 'none';
    });

    document.getElementById('closeRecordDetailModal').addEventListener('click', () => {
      document.getElementById('recordDetailModal').style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      const savedRecordsModal = document.getElementById('savedRecordsModal');
      const recordDetailModal = document.getElementById('recordDetailModal');

      if (event.target === savedRecordsModal) {
        savedRecordsModal.style.display = 'none';
      }
      if (event.target === recordDetailModal) {
        recordDetailModal.style.display = 'none';
      }
    });

    // åˆå§‹åŒ– IndexedDB
    initIndexedDB().catch(err => console.error('IndexedDBåˆå§‹åŒ–å¤±è´¥:', err));
    // Tabåˆ‡æ¢é€»è¾‘
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;

        // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        // æ¿€æ´»å½“å‰tab
        btn.classList.add('active');
        document.getElementById(`${tabId}Tab`).classList.add('active');
      });
    });

    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
    uploadArea.addEventListener('click', () => fileInput.click());

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFile(e.dataTransfer.files[0]);
    });
    saveRecordBtn.addEventListener('click', async () => {
      if (!currentPromptData || !currentCompressedImage) {
        showMessage('æ²¡æœ‰å¯ä¿å­˜çš„æ•°æ®', 'é”™è¯¯', 2000);
        return;
      }

      try {
        const record = {
          imageBase64: currentCompressedImage,
          promptData: currentPromptData,
          timestamp: new Date().toISOString()
        };

        await saveRecordToDB(record);
        showMessage('ä¿å­˜æˆåŠŸï¼', 'æˆåŠŸ', 2000);
      } catch (error) {
        showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'é”™è¯¯', 3000);
      }
    });

    // æŸ¥çœ‹å·²ä¿å­˜è®°å½•æŒ‰é’®äº‹ä»¶
    savedRecordsBtn.addEventListener('click', async () => {
      try {
        const records = await getAllRecords();
        displaySavedRecords(records);
        document.getElementById('savedRecordsModal').style.display = 'block';
      } catch (error) {
        showMessage('åŠ è½½è®°å½•å¤±è´¥: ' + error.message, 'é”™è¯¯', 3000);
      }
    });
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFile(file) {
      if (!file || !file.type.startsWith('image/')) {
        showMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'é”™è¯¯', 3000);
        return;
      }

      selectedFile = file;
      generateBtn.disabled = false;

      // é¢„è§ˆå›¾ç‰‡ - å›ºå®šé•¿å®½æ¯”å±•ç¤º
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        uploadArea.classList.add('has-image');
      };
      reader.readAsDataURL(file);
      resultSection.style.display = 'none';
      mainLayout.classList.remove('has-result');
    }

    // ç”Ÿæˆæç¤ºè¯
    generateBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      // è·å–ä¿å­˜çš„APIè®¾ç½®
      const apiSettings = getSavedApiSettings();
      if (!apiSettings) {
        showMessage('è¯·å…ˆè®¾ç½®API Key', 'é”™è¯¯', 3000);
        return;
      }

      const formData = new FormData();
      formData.append('image', selectedFile);
      // æ·»åŠ APIé…ç½®åˆ°è¯·æ±‚ä¸­
      formData.append('api_model', apiSettings.model);
      formData.append('model_version', apiSettings.version);
      // å‘é€åŠ å¯†åçš„API Key
      formData.append('api_key', apiSettings.apiKey);

      loading.style.display = 'flex';
      resultSection.style.display = 'none';
      generateBtn.disabled = true;
      try {
        const response = await fetch("/generate_prompt", {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          mainLayout.classList.add('has-result');
          displayResults(data.prompt_data, data.compressed_image);
        } else {
          showMessage(data.error || 'ç”Ÿæˆå¤±è´¥,è¯·é‡è¯•', 'é”™è¯¯', 3000);
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'é”™è¯¯', 3000);
      } finally {
        loading.style.display = 'none';
        generateBtn.disabled = false;
      }
    });

    // å±•ç¤ºç”Ÿæˆç»“æœ
    function displayResults(promptData, compressedImage) {
      if (promptData.raw_response) {
        showMessage('AI è¿”å›æ ¼å¼å¼‚å¸¸,è¯·é‡è¯•', 'é”™è¯¯', 3000);
        return;
      }

      // ä¿å­˜å½“å‰æ•°æ®ä¾›ä¿å­˜åŠŸèƒ½ä½¿ç”¨
      currentPromptData = promptData;
      currentCompressedImage = compressedImage;

      // æ›´æ–°é¢„è§ˆå›¾ç‰‡ä¸ºå‹ç¼©åçš„ç‰ˆæœ¬
      if (compressedImage) {
        previewImage.src = `data:image/jpeg;base64,${compressedImage}`;
      }

      const enDetails = document.getElementById('englishPromptDetails');
      enDetails.innerHTML = generatePromptFields(promptData.english_prompt, 'en');

      const cnDetails = document.getElementById('chinesePromptDetails');
      cnDetails.innerHTML = generatePromptFields(promptData.chinese_prompt, 'cn');

      document.getElementById('fullPromptEn').value = generateFullPrompt(promptData.english_prompt, 'en');
      document.getElementById('fullPromptCn').value = generateFullPrompt(promptData.chinese_prompt, 'cn');

      resultSection.style.display = 'block';
    }

    function generateFullPrompt(promptObj, lang) {
      const labels = {
        'en': {
          'style_medium': 'style_medium',
          'style_details': 'style_details',
          'scene': 'scene',
          'subject': 'subject',
          'outfit_props': 'outfit_props',
          'background': 'background',
          'composition': 'composition',
          'lighting_color': 'lighting_color',
          'special_effects': 'special_effects',
          'technical_quality': 'technical_quality',
          'avoid': 'avoid'
        },
        'cn': {
          'style_medium': 'é£æ ¼ä¸åª’ä»‹',
          'style_details': 'é£æ ¼ç»†èŠ‚',
          'scene': 'åœºæ™¯æè¿°',
          'subject': 'ä¸»ä½“è§’è‰²',
          'outfit_props': 'æœè£…é“å…·',
          'background': 'èƒŒæ™¯',
          'composition': 'æ„å›¾è§†è§’',
          'lighting_color': 'å…‰ç…§è‰²è°ƒ',
          'special_effects': 'ç‰¹æ®Šæ•ˆæœ',
          'technical_quality': 'æŠ€æœ¯ç»†èŠ‚',
          'avoid': 'é¿å…å…ƒç´ '
        }
      };

      const langLabels = labels[lang === 'en' ? 'en' : 'cn'];
      const header = lang === 'en' ? "Generate image:\n" : "ç”Ÿæˆå›¾åƒï¼š\n";
      let prompt = header;

      for (const [key, label] of Object.entries(langLabels)) {
        if (promptObj[key]) {
          prompt += `${label}: ${promptObj[key]}\n`;
        }
      }

      return prompt;
    }
    // ç”Ÿæˆæç¤ºè¯å­—æ®µï¼ˆå¯ç¼–è¾‘+å¯å¤åˆ¶ï¼‰
    function generatePromptFields(promptObj, lang) {
      const fieldLabels = {
        'style_medium': lang === 'cn' ? 'é£æ ¼ä¸åª’ä»‹' : 'Style & Medium',
        'style_details': lang === 'cn' ? 'é£æ ¼ç»†èŠ‚' : 'Style Details',
        'scene': lang === 'cn' ? 'åœºæ™¯æè¿°' : 'Scene Description',
        'subject': lang === 'cn' ? 'ä¸»ä½“è§’è‰²' : 'Main Subject',
        'outfit_props': lang === 'cn' ? 'æœè£…é“å…·' : 'Outfit & Props',
        'background': lang === 'cn' ? 'èƒŒæ™¯' : 'Background',
        'composition': lang === 'cn' ? 'æ„å›¾è§†è§’' : 'Composition & Perspective',
        'lighting_color': lang === 'cn' ? 'å…‰ç…§è‰²è°ƒ' : 'Lighting & Color',
        'special_effects': lang === 'cn' ? 'ç‰¹æ®Šæ•ˆæœ' : 'Special Effects',
        'avoid': lang === 'cn' ? 'é¿å…å…ƒç´ ' : 'Avoid Elements'
      };

      let html = '';
      for (const [key, label] of Object.entries(fieldLabels)) {
        if (promptObj[key]) {
          html += `
            <div class="prompt-field">
              <span class="prompt-label">${label}</span>
              <div class="prompt-value">${promptObj[key]}</div>
            </div>
          `;
        }
      }
      return html;
    }

    // å¤åˆ¶å®Œæ•´æç¤ºè¯
    function copyFullPrompt(elementId, button) {
      const text = document.getElementById(elementId).value;

      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'âœ“ å·²å¤åˆ¶';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        showMessage('å¤åˆ¶å¤±è´¥: ' + err.message, 'é”™è¯¯', 3000);
      });
    }

    // ç¡®è®¤å¼¹çª—å‡½æ•°
    function showConfirm(message) {
      return new Promise((resolve) => {
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmOk = document.getElementById('confirmOk');
        const confirmCancel = document.getElementById('confirmCancel');

        confirmMessage.textContent = message;
        confirmModal.style.display = 'block';

        const handleResult = (result) => {
          confirmModal.style.display = 'none';
          resolve(result);
          confirmOk.removeEventListener('click', handleOk);
          confirmCancel.removeEventListener('click', handleCancel);
        };

        const handleOk = () => handleResult(true);
        const handleCancel = () => handleResult(false);

        confirmOk.addEventListener('click', handleOk);
        confirmCancel.addEventListener('click', handleCancel);
      });
    }

    // æ¶ˆæ¯å¼¹çª—
    function showMessage(message, title = 'æç¤º', duration = 3000) {
      const modal = document.getElementById('messageModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');

      modalTitle.textContent = title;
      modalMessage.textContent = message;

      modal.style.display = 'block';

      // è‡ªåŠ¨å…³é—­
      setTimeout(() => {
        modal.style.display = 'none';
      }, duration);
    }
    apiSettingsBtn.addEventListener('click', () => {
      const savedSettings = getSavedApiSettings();
      if (savedSettings) {
        aiModelSelect.value = savedSettings.model;
        updateModelVersions(savedSettings.model);
        modelVersionSelect.value = savedSettings.version;

        // ä¸æ˜¾ç¤ºå®é™…çš„API Keyï¼Œåªæ˜¾ç¤ºå ä½ç¬¦
        const apiKeyInput = document.getElementById('apiKey');
        apiKeyInput.value = '';
        apiKeyInput.placeholder = 'å·²ä¿å­˜åŠ å¯†API Keyï¼Œå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥';
      }

      apiSettingsModal.style.display = 'block';
    });

    cancelApiSettings.addEventListener('click', () => {
      apiSettingsModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target === apiSettingsModal) {
        apiSettingsModal.style.display = 'none';
      }
      if (event.target === messageModal) {
        messageModal.style.display = 'none';
      }
    });
    aiModelSelect.addEventListener('change', (e) => {
      const newModel = e.target.value;

      // æ›´æ–°æ¨¡å‹ç‰ˆæœ¬
      updateModelVersions(newModel);

      // ä»aiModelsä¸­è·å–å¯¹åº”æ¨¡å‹çš„API Keyå¹¶æ˜¾ç¤º
      const modelConfig = currentModels.find(m => m.id === newModel);
      const apiKeyInput = document.getElementById('apiKey');

      if (modelConfig && modelConfig.apiKey) {
        // æ˜¾ç¤ºå ä½ç¬¦ï¼Œä¸æ˜¾ç¤ºå®é™…Key
        apiKeyInput.value = '';
        apiKeyInput.placeholder = 'å·²ä¿å­˜åŠ å¯†API Keyï¼Œå¦‚éœ€ä¿®æ”¹è¯·é‡æ–°è¾“å…¥';
      } else {
        apiKeyInput.value = '';
        apiKeyInput.placeholder = 'è¯·è¾“å…¥API Key';
      }
    });


    // æ›´æ–°æ¨¡å‹ç‰ˆæœ¬é€‰æ‹©å™¨
    function updateModelVersions(modelId) {
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      modelVersionSelect.innerHTML = '';

      // è·å–å½“å‰æ¨¡å‹çš„ç‰ˆæœ¬
      const modelConfig = currentModels.find(m => m.id === modelId);
      if (modelConfig && modelConfig.versions) {
        // æ·»åŠ æ–°é€‰é¡¹
        modelConfig.versions.forEach(version => {
          const option = document.createElement('option');
          option.value = version.value;
          option.textContent = version.text;
          modelVersionSelect.appendChild(option);
        });

        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
        if (modelConfig.versions.length > 0) {
          modelVersionSelect.selectedIndex = 0;
        }
      }
    }
    // ä¿å­˜APIè®¾ç½®
    saveApiSettings.addEventListener('click', async () => {
      const model = aiModelSelect.value;
      const version = modelVersionSelect.value;
      const apiKeyInput = document.getElementById('apiKey').value;

      if (!model || !version) {
        showMessage('è¯·é€‰æ‹©AIæ¨¡å‹å’Œæ¨¡å‹ç‰ˆæœ¬', 'é”™è¯¯', 3000);
        return;
      }

      const settings = {
        model: model,
        version: version
      };

      // è·å–å½“å‰æ¨¡å‹é…ç½®
      const modelConfig = currentModels.find(m => m.id === model);
      if (!modelConfig) {
        showMessage('æœªæ‰¾åˆ°å¯¹åº”çš„æ¨¡å‹é…ç½®', 'é”™è¯¯', 3000);
        return;
      }

      let needEncrypt = false;

      // å¦‚æœæœ‰è¾“å…¥æ–°çš„API Keyï¼Œéœ€è¦åŠ å¯†
      if (apiKeyInput) {
        try {
          const response = await fetch("/encrypt_api_key", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ api_key: apiKeyInput })
          });

          const data = await response.json();

          if (data.success) {
            // ä¿å­˜åŠ å¯†åçš„API Keyåˆ°æ¨¡å‹é…ç½®ä¸­
            modelConfig.apiKey = data.encrypted_key;
            settings.apiKey = data.encrypted_key;
            needEncrypt = true;
          } else {
            showMessage('API KeyåŠ å¯†å¤±è´¥: ' + data.error, 'é”™è¯¯', 3000);
            return;
          }
        } catch (error) {
          showMessage('åŠ å¯†API Keyæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'é”™è¯¯', 3000);
          return;
        }
      } else {
        // æ²¡æœ‰è¾“å…¥æ–°Keyï¼Œä½¿ç”¨æ¨¡å‹é…ç½®ä¸­å·²ä¿å­˜çš„åŠ å¯†Key
        if (modelConfig.apiKey) {
          settings.apiKey = modelConfig.apiKey;
        } else {
          showMessage('è¯·è¾“å…¥API Key', 'é”™è¯¯', 3000);
          return;
        }
      }

      // ä¿å­˜è®¾ç½®åˆ°localStorage
      localStorage.setItem('apiSettings', JSON.stringify(settings));

      // å¦‚æœåŠ å¯†äº†æ–°çš„API Keyï¼Œæ›´æ–°æ¨¡å‹é…ç½®
      if (needEncrypt) {
        localStorage.setItem('aiModels', JSON.stringify(currentModels));
      }

      updateCurrentModelDisplay();
      apiSettingsModal.style.display = 'none';
      showMessage('APIè®¾ç½®å·²ä¿å­˜', 'æˆåŠŸ', 2000);
    });
    function getSavedApiSettings() {
      const settingsStr = localStorage.getItem('apiSettings');
      if (settingsStr) {
        try {
          const settings = JSON.parse(settingsStr);

          // ä»aiModelsä¸­è·å–æœ€æ–°çš„API Key
          const modelConfig = currentModels.find(m => m.id === settings.model);
          if (modelConfig && modelConfig.apiKey) {
            settings.apiKey = modelConfig.apiKey;
          }

          return settings;
        } catch (e) {
          console.error('è§£æAPIè®¾ç½®å¤±è´¥:', e);
          return null;
        }
      }
      return null;
    }

    // æ›´æ–°å½“å‰æ¨¡å‹æ˜¾ç¤º
    function updateCurrentModelDisplay() {
      const savedSettings = getSavedApiSettings();
      const currentModelDisplay = document.getElementById('currentModelDisplay');

      if (savedSettings) {
        // æ‰¾åˆ°å½“å‰æ¨¡å‹çš„åç§°
        const model = currentModels.find(m => m.id === savedSettings.model);
        const modelName = model ? model.name : savedSettings.model;

        // æ‰¾åˆ°å½“å‰ç‰ˆæœ¬çš„æ˜¾ç¤ºæ–‡æœ¬
        let versionText = savedSettings.version;
        if (model && model.versions) {
          const version = model.versions.find(v => v.value === savedSettings.version);
          versionText = version ? version.text : savedSettings.version;
        }
        currentModelDisplay.textContent = `å½“å‰æ¨¡å‹: ${modelName} (${versionText})`;
      }
    }

    // åˆå§‹åŒ–
    function initModels() {
      const savedModels = localStorage.getItem('aiModels');
      if (savedModels) {
        try {
          currentModels = JSON.parse(savedModels);

          // ç¡®ä¿æ¯ä¸ªæ¨¡å‹éƒ½æœ‰apiKeyå­—æ®µ
          currentModels.forEach(model => {
            if (!model.hasOwnProperty('apiKey')) {
              model.apiKey = '';
            }
          });
        } catch (e) {
          console.error('è§£ææ¨¡å‹é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', e);
          currentModels = JSON.parse(JSON.stringify(defaultModels));
        }
      } else {
        currentModels = JSON.parse(JSON.stringify(defaultModels));
      }

      // ä¿å­˜æ›´æ–°åçš„æ¨¡å‹é…ç½®
      localStorage.setItem('aiModels', JSON.stringify(currentModels));
      updateModelSelectors();
      updateCurrentModelDisplay();
    }
    // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
    function updateModelSelectors() {
      aiModelSelect.innerHTML = '';
      modelSelector.innerHTML = '';

      currentModels.forEach(model => {
        // æ›´æ–°ä¸»æ¨¡å‹é€‰æ‹©å™¨
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.name;
        aiModelSelect.appendChild(option);

        // æ›´æ–°æ¨¡å‹ç®¡ç†ä¸­çš„é€‰æ‹©å™¨
        const selectorOption = document.createElement('option');
        selectorOption.value = model.id;
        selectorOption.textContent = model.name;
        modelSelector.appendChild(selectorOption);
      });

      updateModelListDisplay();
    }

    function updateModelListDisplay() {
      modelListContainer.innerHTML = '';

      currentModels.forEach((model, modelIndex) => {
        const modelDiv = document.createElement('div');
        modelDiv.className = 'model-item';
        modelDiv.style.border = '1px solid #ddd';
        modelDiv.style.borderRadius = '8px';
        modelDiv.style.padding = '15px';
        modelDiv.style.marginBottom = '15px';
        modelDiv.style.backgroundColor = '#f9f9fb';

        modelDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0;">${model.name} (${model.id})</h4>
          </div>
          <div>
            <strong>ç‰ˆæœ¬åˆ—è¡¨:</strong>
            <ul id="versions-list-${modelIndex}" style="margin-top: 10px; padding-left: 20px;">
              ${model.versions ? model.versions.map((version, versionIndex) => `
                <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <span>${version.text} (${version.value})</span>
                  <button class="remove-version-btn btn btn-secondary" data-model-index="${modelIndex}" data-version-index="${versionIndex}" style="padding: 2px 6px; font-size: 0.7rem;">åˆ é™¤</button>
                </li>
              `).join('') : '<li>æ— ç‰ˆæœ¬</li>'}
            </ul>
          </div>
        `;

        modelListContainer.appendChild(modelDiv);
      });
      bindRemoveEvents();
    }

    function bindRemoveEvents() {
      document.querySelectorAll('.remove-version-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const modelIndex = parseInt(e.target.getAttribute('data-model-index'));
          const versionIndex = parseInt(e.target.getAttribute('data-version-index'));

          if (!currentModels[modelIndex] || !currentModels[modelIndex].versions) {
            return;
          }

          const versionText = currentModels[modelIndex].versions[versionIndex].text;

          const result = await showConfirm(`ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ "${versionText}" å—ï¼Ÿ`);
          if (result) {
            currentModels[modelIndex].versions.splice(versionIndex, 1);
            updateModelListDisplay();
          }
        });
      });
    }

    manageModelsBtn.addEventListener('click', () => {
      apiSettingsModal.style.display = 'none';
      modelManagementModal.style.display = 'block';
      updateModelListDisplay();
    });

    cancelModelManagement.addEventListener('click', () => {
      modelManagementModal.style.display = 'none';
      apiSettingsModal.style.display = 'block';
      reloadCurrentModelSettings();
    });

    window.addEventListener('click', (event) => {
      if (event.target === modelManagementModal) {
        modelManagementModal.style.display = 'none';
        apiSettingsModal.style.display = 'block';
        reloadCurrentModelSettings();
      }
    });

    // æ·»åŠ æ–°ç‰ˆæœ¬
    addVersionBtn.addEventListener('click', () => {
      const selectedModelId = modelSelector.value;
      const newVersionValue = document.getElementById('newVersionValue').value.trim();
      const newVersionText = document.getElementById('newVersionText').value.trim();

      if (!selectedModelId || !newVersionValue || !newVersionText) {
        showMessage('è¯·é€‰æ‹©æ¨¡å‹å¹¶å¡«å†™ç‰ˆæœ¬ä¿¡æ¯', 'é”™è¯¯', 3000);
        return;
      }
      const model = currentModels.find(m => m.id === selectedModelId);
      if (!model) {
        showMessage('æœªæ‰¾åˆ°é€‰ä¸­çš„æ¨¡å‹', 'é”™è¯¯', 3000);
        return;
      }

      // ç¡®ä¿ç‰ˆæœ¬æ•°ç»„å­˜åœ¨
      if (!model.versions) {
        model.versions = [];
      }

      // æ£€æŸ¥é‡å¤
      if (model.versions.some(v => v.value === newVersionValue)) {
        showMessage('è¯¥æ¨¡å‹ä¸‹å·²å­˜åœ¨ç›¸åŒç‰ˆæœ¬å€¼', 'é”™è¯¯', 3000);
        return;
      }

      // æ·»åŠ æ–°ç‰ˆæœ¬
      model.versions.push({
        value: newVersionValue,
        text: newVersionText
      });

      document.getElementById('newVersionValue').value = '';
      document.getElementById('newVersionText').value = '';
      updateModelListDisplay();
    });

    saveModelsBtn.addEventListener('click', () => {
      localStorage.setItem('aiModels', JSON.stringify(currentModels));
      updateModelSelectors();

      modelManagementModal.style.display = 'none';
      apiSettingsModal.style.display = 'block';
      updateCurrentModelDisplay();
      reloadCurrentModelSettings();
    });

    resetModelsBtn.addEventListener('click', async () => {
      const result = await showConfirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æ¨¡å‹é…ç½®å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚');
      if (result) {
        currentModels = JSON.parse(JSON.stringify(defaultModels)); // æ·±æ‹·è´é»˜è®¤é…ç½®
        localStorage.setItem('aiModels', JSON.stringify(defaultModels));
        updateModelListDisplay();
        updateModelSelectors();
        updateCurrentModelDisplay();
        showMessage('å·²æ¢å¤é»˜è®¤é…ç½®', 'æˆåŠŸ', 2000);
      }
    });

    function reloadCurrentModelSettings() {
      const savedSettings = getSavedApiSettings();
      if (savedSettings) {
        aiModelSelect.value = savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini');
        updateModelVersions(savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini'));
        modelVersionSelect.value = savedSettings.version || '';
      } else {
        const defaultModel = currentModels.length > 0 ? currentModels[0].id : 'gemini';
        aiModelSelect.value = defaultModel;
        updateModelVersions(defaultModel);
        if (modelVersionSelect.options.length > 0) {
          modelVersionSelect.selectedIndex = 0;
        }
      }
    };

    initModels();
    updateCurrentModelDisplay();
  </script>
</body>

</html>