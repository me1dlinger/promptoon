<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»˜ç”»æç¤ºè¯ç”Ÿæˆå™¨</title>
  <link
    href="data:image/x-icon;base64,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"
    rel="icon" type="image/x-icon" />
  <link rel="shortcut icon"
    href="data:image/x-icon;base64,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"
    type="image/x-icon" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
  <header>
    <h1>PROMPTOON</h1>
    <p class="subtitle">ä¸Šä¼ å›¾ç‰‡,è‡ªåŠ¨åæ¨ç”Ÿæˆ AI ç»˜ç”»æç¤ºè¯</p>
    <!-- å½“å‰æ¨¡å‹æ˜¾ç¤º -->
    <div class="current-model-display" id="currentModelDisplay">å½“å‰æ¨¡å‹: æ— </div>
    <!-- APIè®¾ç½®æŒ‰é’® -->
    <div class="api-settings-btn" id="apiSettingsBtn">âš™ï¸</div>
  </header>

  <div class="container">
    <div class="main-layout" id="mainLayout">
      <div class="upload-section">
        <div class="upload-area" id="uploadArea">
          <div class="upload-content">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
            <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼</div>
          </div>
          <div class="preview-image-wrapper">
            <img id="previewImage" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
            <div class="loading" id="loading">
              <div class="spinner"></div>
              <p>æ­£åœ¨åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆæç¤ºè¯...</p>
            </div>
          </div>
          <input type="file" id="fileInput" accept="image/*">
        </div>
        <button class="btn" id="generateBtn" disabled>ç”Ÿæˆæç¤ºè¯</button>
      </div>
      <!-- æ¶ˆæ¯å¼¹çª— -->
      <div class="message-modal" id="messageModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title" id="modalTitle">æç¤º</span>
          </div>
          <div class="modal-body">
            <p id="modalMessage"></p>
          </div>
        </div>
      </div>
      <!-- APIè®¾ç½®å¼¹çª— -->
      <div class="modal" id="apiSettingsModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title">APIè®¾ç½®</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="aiModel">AIæ¨¡å‹:
                <button id="manageModelsBtn" class="btn btn-secondary"
                  style="float: right; padding: 4px 8px; font-size: 0.8rem;">ç®¡ç†æ¨¡å‹</button>
              </label>
              <select id="aiModel" class="form-control">
                <option value="gemini">GEMINI</option>
                <option value="doubao">è±†åŒ…</option>
              </select>
            </div>

            <div class="form-group">
              <label for="modelVersion">æ¨¡å‹ç‰ˆæœ¬:</label>
              <select id="modelVersion" class="form-control">
              </select>
            </div>

            <div class="form-group">
              <label for="apiKey">API Key:</label>
              <input type="password" id="apiKey" class="form-control" placeholder="è¯·è¾“å…¥API Key">
            </div>

            <div class="form-actions">
              <button id="saveApiSettings" class="btn">ä¿å­˜</button>
              <button id="cancelApiSettings" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- æ¨¡å‹ç®¡ç†å¼¹çª— -->
      <div class="modal" id="modelManagementModal">
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <span class="modal-title">æ¨¡å‹ç®¡ç†</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>å½“å‰æ¨¡å‹åˆ—è¡¨:</label>
              <div id="modelListContainer">
                <!-- æ¨¡å‹åˆ—è¡¨ -->
              </div>
            </div>
            <div class="form-group">
              <label>ä¸ºé€‰ä¸­æ¨¡å‹æ·»åŠ ç‰ˆæœ¬:</label>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <select id="modelSelector" class="form-control" style="flex: 1;">
                  <!-- æ¨¡å‹é€‰é¡¹ -->
                </select>
                <input type="text" id="newVersionValue" class="form-control"
                  placeholder="ç‰ˆæœ¬å€¼ (å¦‚: gemini-2.5-flash-lite)" style="flex: 1;">
                <input type="text" id="newVersionText" class="form-control" placeholder="ç‰ˆæœ¬æ˜¾ç¤ºæ–‡æœ¬" style="flex: 1;">
                <button id="addVersionBtn" class="model-btn">æ·»åŠ ç‰ˆæœ¬</button>
              </div>
            </div>

            <div class="form-actions">
              <button id="resetModelsBtn" class="btn btn-secondary">æ¢å¤é»˜è®¤</button>
              <button id="saveModelsBtn" class="btn">ä¿å­˜</button>
              <button id="cancelModelManagement" class="btn btn-secondary">å…³é—­</button>
            </div>
          </div>
        </div>
      </div>

      <div class="result-section" id="resultSection">
        <div class="tab-container">
          <div class="tab-buttons">
            <button class="tab-btn active" data-tab="cn">ä¸­æ–‡æç¤ºè¯</button>
            <button class="tab-btn" data-tab="en">English Prompt</button>
          </div>
          <div class="tab-content active" id="cnTab">
            <div class="prompt-card">
              <h3>
                ä¸­æ–‡æç¤ºè¯
              </h3>
              <div class="prompt-card-content" id="chinesePromptDetails"></div>
              <div class="full-prompt-box">
                <div class="prompt-label full">å®Œæ•´æè¿°</div>
                <textarea class="full-prompt-text" id="fullPromptCn"></textarea>
                <button class="copy-btn" onclick="copyFullPrompt('fullPromptCn', this)">å¤åˆ¶</button>
              </div>
            </div>
          </div>
          <div class="tab-content" id="enTab">
            <div class="prompt-card">
              <h3>
                English Prompt
              </h3>
              <div class="prompt-card-content" id="englishPromptDetails"></div>
              <div class="full-prompt-box">
                <div class="prompt-label full">å®Œæ•´æç¤ºè¯</div>
                <textarea class="full-prompt-text" id="fullPromptEn"></textarea>
                <button class="copy-btn" onclick="copyFullPrompt('fullPromptEn', this)">å¤åˆ¶</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ç¡®è®¤å¼¹çª— -->
    <div class="modal confirm-modal" id="confirmModal">
      <div class="confirm-modal-content">
        <div class="confirm-modal-body">
          <div class="confirm-modal-message" id="confirmMessage"></div>
          <div class="confirm-modal-actions">
            <button class="confirm-btn secondary" id="confirmCancel">å–æ¶ˆ</button>
            <button class="confirm-btn primary" id="confirmOk">ç¡®å®š</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const generateBtn = document.getElementById('generateBtn');
    const previewImage = document.getElementById('previewImage');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const mainLayout = document.getElementById('mainLayout');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const manageModelsBtn = document.getElementById('manageModelsBtn');
    const modelManagementModal = document.getElementById('modelManagementModal');
    const cancelModelManagement = document.getElementById('cancelModelManagement');
    const addVersionBtn = document.getElementById('addVersionBtn');
    const saveModelsBtn = document.getElementById('saveModelsBtn');
    const resetModelsBtn = document.getElementById('resetModelsBtn');
    const modelListContainer = document.getElementById('modelListContainer');
    const modelSelector = document.getElementById('modelSelector');
    const apiSettingsBtn = document.getElementById('apiSettingsBtn');
    const apiSettingsModal = document.getElementById('apiSettingsModal');
    const cancelApiSettings = document.getElementById('cancelApiSettings');
    const aiModelSelect = document.getElementById('aiModel');
    const modelVersionSelect = document.getElementById('modelVersion');
    const saveApiSettings = document.getElementById('saveApiSettings');

    // é»˜è®¤æ¨¡å‹é…ç½®
    const defaultModels = [
      {
        id: 'gemini',
        name: 'GEMINI',
        versions: [
          { value: 'gemini-2.5-flash-lite', text: 'gemini-2.5-flash-lite' },
          { value: 'gemini-3.0-pro', text: 'gemini-3.0-pro' }
        ]
      },
      {
        id: 'doubao',
        name: 'è±†åŒ…',
        versions: [
          { value: 'Doubao-Seed-1.8', text: 'Doubao-Seed-1.8' },
          { value: 'doubao-seed-1-6-lite-251015', text: 'Doubao-Seed-1.6-Lite' },
          { value: 'Doubao-Seed-1.6-flash', text: 'Doubao-Seed-1.6-flash' }
        ]
      }
    ];

    let currentModels = [];
    let selectedFile = null;

    // Tabåˆ‡æ¢é€»è¾‘
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;

        // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        // æ¿€æ´»å½“å‰tab
        btn.classList.add('active');
        document.getElementById(`${tabId}Tab`).classList.add('active');
      });
    });

    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
    uploadArea.addEventListener('click', () => fileInput.click());

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFile(e.dataTransfer.files[0]);
    });
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFile(file) {
      if (!file) {
        showMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶', 'é”™è¯¯', 3000);
        return;
      }

      // ä¸¥æ ¼æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼Œåªå…è®¸ jpg, jpeg, png, webpï¼Œä¸å…è®¸ gif
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
      if (!allowedTypes.includes(file.type.toLowerCase())) {
        showMessage('åªæ”¯æŒ JPGã€PNGã€WebP æ ¼å¼çš„å›¾ç‰‡æ–‡ä»¶ï¼Œä¸æ”¯æŒ GIF', 'é”™è¯¯', 3000);
        return;
      }

      // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆå‰ç«¯åˆæ­¥æ£€æŸ¥ï¼Œåç«¯è¿˜ä¼šå†æ¬¡éªŒè¯ï¼‰
      if (file.size > 10 * 1024 * 1024) { // 10MB
        showMessage('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB', 'é”™è¯¯', 3000);
        return;
      }

      selectedFile = file;
      generateBtn.disabled = false;

      // é¢„è§ˆå›¾ç‰‡ - å›ºå®šé•¿å®½æ¯”å±•ç¤º
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        uploadArea.classList.add('has-image');
      };
      reader.readAsDataURL(file);
      resultSection.style.display = 'none';
      mainLayout.classList.remove('has-result');
      loading.style.display = 'none';
    }

    // ç”Ÿæˆæç¤ºè¯
    generateBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      // è·å–ä¿å­˜çš„APIè®¾ç½®
      const apiSettings = getSavedApiSettings();
      if (!apiSettings) {
        showMessage('è¯·å…ˆè®¾ç½®API Key', 'é”™è¯¯', 3000);
        return;
      }

      const formData = new FormData();
      formData.append('image', selectedFile);
      // æ·»åŠ APIé…ç½®åˆ°è¯·æ±‚ä¸­
      formData.append('api_model', apiSettings.model);
      formData.append('model_version', apiSettings.version);
      // å‘é€åŠ å¯†åçš„API Key
      formData.append('api_key', apiSettings.apiKey);

      loading.style.display = 'flex';
      resultSection.style.display = 'none';
      generateBtn.disabled = true;
      try {
        const response = await fetch("/generate_prompt", {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          // åˆ‡æ¢åˆ°å·¦å³å¸ƒå±€
          mainLayout.classList.add('has-result');
          displayResults(data.prompt_data);
        } else {
          showMessage(data.error || 'ç”Ÿæˆå¤±è´¥,è¯·é‡è¯•', 'é”™è¯¯', 3000);
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'é”™è¯¯', 3000);
      } finally {
        loading.style.display = 'none';
        generateBtn.disabled = false;
      }
    });

    // å±•ç¤ºç”Ÿæˆç»“æœ
    function displayResults(promptData) {
      // å¦‚æœæ˜¯åŸå§‹å“åº”æ ¼å¼
      if (promptData.raw_response) {
        showMessage('AI è¿”å›æ ¼å¼å¼‚å¸¸,è¯·é‡è¯•', 'é”™è¯¯', 3000);
        return;
      }

      // æ˜¾ç¤ºè‹±æ–‡æç¤ºè¯è¯¦æƒ…
      const enDetails = document.getElementById('englishPromptDetails');
      enDetails.innerHTML = generatePromptFields(promptData.english_prompt, 'en');

      // æ˜¾ç¤ºä¸­æ–‡æç¤ºè¯è¯¦æƒ…
      const cnDetails = document.getElementById('chinesePromptDetails');
      cnDetails.innerHTML = generatePromptFields(promptData.chinese_prompt, 'cn');

      // æ˜¾ç¤ºå®Œæ•´æç¤ºè¯
      document.getElementById('fullPromptEn').value = promptData.full_prompt_en || '';
      document.getElementById('fullPromptCn').value = promptData.full_prompt_cn || '';

      resultSection.style.display = 'block';
    }

    // ç”Ÿæˆæç¤ºè¯å­—æ®µï¼ˆå¯ç¼–è¾‘+å¯å¤åˆ¶ï¼‰
    function generatePromptFields(promptObj, lang) {
      const fieldLabels = {
        'style_medium': lang === 'cn' ? 'é£æ ¼ä¸åª’ä»‹' : 'Style & Medium',
        'style_details': lang === 'cn' ? 'é£æ ¼ç»†èŠ‚' : 'Style Details',
        'scene': lang === 'cn' ? 'åœºæ™¯æè¿°' : 'Scene Description',
        'subject': lang === 'cn' ? 'ä¸»ä½“è§’è‰²' : 'Main Subject',
        'outfit_props': lang === 'cn' ? 'æœè£…é“å…·' : 'Outfit & Props',
        'background': lang === 'cn' ? 'èƒŒæ™¯' : 'Background',
        'composition': lang === 'cn' ? 'æ„å›¾è§†è§’' : 'Composition & Perspective',
        'lighting_color': lang === 'cn' ? 'å…‰ç…§è‰²è°ƒ' : 'Lighting & Color',
        'special_effects': lang === 'cn' ? 'ç‰¹æ®Šæ•ˆæœ' : 'Special Effects',
        'avoid': lang === 'cn' ? 'é¿å…å…ƒç´ ' : 'Avoid Elements'
      };

      let html = '';
      for (const [key, label] of Object.entries(fieldLabels)) {
        if (promptObj[key]) {
          html += `
            <div class="prompt-field">
              <span class="prompt-label">${label}</span>
              <div class="prompt-value">${promptObj[key]}</div>
            </div>
          `;
        }
      }
      return html;
    }

    // å¤åˆ¶å®Œæ•´æç¤ºè¯
    function copyFullPrompt(elementId, button) {
      const text = document.getElementById(elementId).value;

      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'âœ“ å·²å¤åˆ¶';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        showMessage('å¤åˆ¶å¤±è´¥: ' + err.message, 'é”™è¯¯', 3000);
      });
    }

    // ç¡®è®¤å¼¹çª—å‡½æ•°
    function showConfirm(message) {
      return new Promise((resolve) => {
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmOk = document.getElementById('confirmOk');
        const confirmCancel = document.getElementById('confirmCancel');

        confirmMessage.textContent = message;
        confirmModal.style.display = 'block';

        const handleResult = (result) => {
          confirmModal.style.display = 'none';
          resolve(result);
          confirmOk.removeEventListener('click', handleOk);
          confirmCancel.removeEventListener('click', handleCancel);
        };

        const handleOk = () => handleResult(true);
        const handleCancel = () => handleResult(false);

        confirmOk.addEventListener('click', handleOk);
        confirmCancel.addEventListener('click', handleCancel);
      });
    }

    // æ¶ˆæ¯å¼¹çª—
    function showMessage(message, title = 'æç¤º', duration = 3000) {
      const modal = document.getElementById('messageModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');

      modalTitle.textContent = title;
      modalMessage.textContent = message;

      modal.style.display = 'block';

      // è‡ªåŠ¨å…³é—­
      setTimeout(() => {
        modal.style.display = 'none';
      }, duration);
    }
    apiSettingsBtn.addEventListener('click', () => {
      // åŠ è½½å·²ä¿å­˜
      const savedSettings = getSavedApiSettings();
      if (savedSettings) {
        aiModelSelect.value = savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini');
        updateModelVersions(savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini'));
        modelVersionSelect.value = savedSettings.version || '';
        // ä¸ºæ¯ä¸ªæ¨¡å‹ç¼“å­˜API KEY
        if (!window.modelApiKeys) {
          window.modelApiKeys = {};
        }
        if (savedSettings.apiKey) {
          window.modelApiKeys[savedSettings.model] = savedSettings.apiKey;
        }
        // æ˜¾ç¤ºå½“å‰æ¨¡å‹çš„API KEYï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        document.getElementById('apiKey').value = window.modelApiKeys[savedSettings.model] || '';
      }

      apiSettingsModal.style.display = 'block';
    });

    cancelApiSettings.addEventListener('click', () => {
      apiSettingsModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target === apiSettingsModal) {
        apiSettingsModal.style.display = 'none';
      }
      if (event.target === messageModal) {
        messageModal.style.display = 'none';
      }
    });
    aiModelSelect.addEventListener('change', (e) => {
      // ç¼“å­˜å½“å‰æ¨¡å‹çš„API KEY
      const savedSettings = getSavedApiSettings();
      const currentModel = savedSettings ? savedSettings.model : (currentModels.length > 0 ? currentModels[0].id : 'gemini');
      const apiKeyInput = document.getElementById('apiKey');

      // åˆå§‹åŒ–æ¨¡å‹API KEYç¼“å­˜å¯¹è±¡
      if (!window.modelApiKeys) {
        window.modelApiKeys = {};
      }

      // ç¼“å­˜å½“å‰æ¨¡å‹çš„API KEY
      if (currentModel && apiKeyInput.value) {
        window.modelApiKeys[currentModel] = apiKeyInput.value;
      }

      // åˆ‡æ¢æ¨¡å‹ç‰ˆæœ¬
      updateModelVersions(e.target.value);

      // æ¢å¤æ–°æ¨¡å‹çš„API KEYï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      const newModel = e.target.value;
      apiKeyInput.value = window.modelApiKeys[newModel] || '';
    });

    // æ›´æ–°æ¨¡å‹ç‰ˆæœ¬é€‰æ‹©å™¨
    function updateModelVersions(modelId) {
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      modelVersionSelect.innerHTML = '';

      // è·å–å½“å‰æ¨¡å‹çš„ç‰ˆæœ¬
      const modelConfig = currentModels.find(m => m.id === modelId);
      if (modelConfig && modelConfig.versions) {
        // æ·»åŠ æ–°é€‰é¡¹
        modelConfig.versions.forEach(version => {
          const option = document.createElement('option');
          option.value = version.value;
          option.textContent = version.text;
          modelVersionSelect.appendChild(option);
        });

        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
        if (modelConfig.versions.length > 0) {
          modelVersionSelect.selectedIndex = 0;
        }
      }
    }
    // ä¿å­˜APIè®¾ç½®
    saveApiSettings.addEventListener('click', async () => {
      const model = aiModelSelect.value;
      const version = modelVersionSelect.value;
      const apiKey = document.getElementById('apiKey').value;

      if (!model || !version) {
        showMessage('è¯·é€‰æ‹©AIæ¨¡å‹å’Œæ¨¡å‹ç‰ˆæœ¬', 'é”™è¯¯', 3000);
        return;
      }

      // æ£€æŸ¥æ˜¯å¦åˆ‡æ¢äº†æ¨¡å‹ä½†æ²¡æœ‰æä¾›æ–°çš„API KEY
      const savedSettings = getSavedApiSettings();
      const isModelChanged = savedSettings && savedSettings.model !== model;

      // å¦‚æœåˆ‡æ¢äº†æ¨¡å‹ä½†æ²¡æœ‰æä¾›API KEYï¼Œé˜»æ­¢ä¿å­˜
      if (isModelChanged && !apiKey) {
        showMessage('åˆ‡æ¢æ¨¡å‹åè¯·è¾“å…¥å¯¹åº”çš„API Key', 'é”™è¯¯', 3000);
        return;
      }

      // å¦‚æœæ²¡æœ‰åˆ‡æ¢æ¨¡å‹ä¸”æ²¡æœ‰è¾“å…¥æ–°çš„API KEYï¼Œä½¿ç”¨åŸæœ‰çš„
      if (!isModelChanged && !apiKey) {
        if (savedSettings && savedSettings.apiKey) {
          // ç¼“å­˜API KEYåˆ°å¯¹åº”æ¨¡å‹
          if (!window.modelApiKeys) {
            window.modelApiKeys = {};
          }
          window.modelApiKeys[model] = ''; // æ¸…ç©ºè¾“å…¥æ¡†ä½†ä¿ç•™åŸæœ‰å¯†é’¥
        } else {
          showMessage('è¯·è¾“å…¥API Key', 'é”™è¯¯', 3000);
          return;
        }
      }

      const settings = {
        model: model,
        version: version
      };

      if (apiKey) {
        try {
          const response = await fetch("/encrypt_api_key", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ api_key: apiKey })
          });

          const data = await response.json();

          if (data.success) {
            settings.apiKey = data.encrypted_key;
            // ç¼“å­˜æ–°è¾“å…¥çš„API KEY
            if (!window.modelApiKeys) {
              window.modelApiKeys = {};
            }
            window.modelApiKeys[model] = apiKey;
          } else {
            showMessage('API KeyåŠ å¯†å¤±è´¥: ' + data.error, 'é”™è¯¯', 3000);
            return;
          }
        } catch (error) {
          showMessage('åŠ å¯†API Keyæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'é”™è¯¯', 3000);
          return;
        }
      } else {
        // ä½¿ç”¨å·²ä¿å­˜çš„API KEY
        if (savedSettings && savedSettings.apiKey) {
          settings.apiKey = savedSettings.apiKey;
        } else {
          showMessage('è¯·è¾“å…¥API Key', 'é”™è¯¯', 3000);
          return;
        }
      }

      localStorage.setItem('apiSettings', JSON.stringify(settings));
      updateCurrentModelDisplay();
      apiSettingsModal.style.display = 'none';
      showMessage('APIè®¾ç½®å·²ä¿å­˜', 'æˆåŠŸ', 2000);
    });

    function getSavedApiSettings() {
      const settingsStr = localStorage.getItem('apiSettings');
      if (settingsStr) {
        try {
          return JSON.parse(settingsStr);
        } catch (e) {
          console.error('è§£æAPIè®¾ç½®å¤±è´¥:', e);
          return null;
        }
      }
      return null;
    }

    // æ›´æ–°å½“å‰æ¨¡å‹æ˜¾ç¤º
    function updateCurrentModelDisplay() {
      const savedSettings = getSavedApiSettings();
      const currentModelDisplay = document.getElementById('currentModelDisplay');

      if (savedSettings) {
        // æ‰¾åˆ°å½“å‰æ¨¡å‹çš„åç§°
        const model = currentModels.find(m => m.id === savedSettings.model);
        const modelName = model ? model.name : savedSettings.model;

        // æ‰¾åˆ°å½“å‰ç‰ˆæœ¬çš„æ˜¾ç¤ºæ–‡æœ¬
        let versionText = savedSettings.version;
        if (model && model.versions) {
          const version = model.versions.find(v => v.value === savedSettings.version);
          versionText = version ? version.text : savedSettings.version;
        }
        currentModelDisplay.textContent = `å½“å‰æ¨¡å‹: ${modelName} (${versionText})`;
      }
    }

    // åˆå§‹åŒ–
    function initModels() {
      const savedModels = localStorage.getItem('aiModels');
      if (savedModels) {
        try {
          currentModels = JSON.parse(savedModels);
        } catch (e) {
          console.error('è§£ææ¨¡å‹é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', e);
          currentModels = JSON.parse(JSON.stringify(defaultModels));
        }
      } else {
        currentModels = JSON.parse(JSON.stringify(defaultModels));
        localStorage.setItem('aiModels', JSON.stringify(defaultModels));
      }
      updateModelSelectors();
      updateCurrentModelDisplay();
    }

    // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
    function updateModelSelectors() {
      aiModelSelect.innerHTML = '';
      modelSelector.innerHTML = '';

      currentModels.forEach(model => {
        // æ›´æ–°ä¸»æ¨¡å‹é€‰æ‹©å™¨
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.name;
        aiModelSelect.appendChild(option);

        // æ›´æ–°æ¨¡å‹ç®¡ç†ä¸­çš„é€‰æ‹©å™¨
        const selectorOption = document.createElement('option');
        selectorOption.value = model.id;
        selectorOption.textContent = model.name;
        modelSelector.appendChild(selectorOption);
      });

      updateModelListDisplay();
    }

    function updateModelListDisplay() {
      modelListContainer.innerHTML = '';

      currentModels.forEach((model, modelIndex) => {
        const modelDiv = document.createElement('div');
        modelDiv.className = 'model-item';
        modelDiv.style.border = '1px solid #ddd';
        modelDiv.style.borderRadius = '8px';
        modelDiv.style.padding = '15px';
        modelDiv.style.marginBottom = '15px';
        modelDiv.style.backgroundColor = '#f9f9fb';

        modelDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0;">${model.name} (${model.id})</h4>
          </div>
          <div>
            <strong>ç‰ˆæœ¬åˆ—è¡¨:</strong>
            <ul id="versions-list-${modelIndex}" style="margin-top: 10px; padding-left: 20px;">
              ${model.versions ? model.versions.map((version, versionIndex) => `
                <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <span>${version.text} (${version.value})</span>
                  <button class="remove-version-btn btn btn-secondary" data-model-index="${modelIndex}" data-version-index="${versionIndex}" style="padding: 2px 6px; font-size: 0.7rem;">åˆ é™¤</button>
                </li>
              `).join('') : '<li>æ— ç‰ˆæœ¬</li>'}
            </ul>
          </div>
        `;

        modelListContainer.appendChild(modelDiv);
      });
      bindRemoveEvents();
    }

    function bindRemoveEvents() {
      document.querySelectorAll('.remove-version-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const modelIndex = parseInt(e.target.getAttribute('data-model-index'));
          const versionIndex = parseInt(e.target.getAttribute('data-version-index'));

          if (!currentModels[modelIndex] || !currentModels[modelIndex].versions) {
            return;
          }

          const versionText = currentModels[modelIndex].versions[versionIndex].text;

          const result = await showConfirm(`ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ "${versionText}" å—ï¼Ÿ`);
          if (result) {
            currentModels[modelIndex].versions.splice(versionIndex, 1);
            updateModelListDisplay();
          }
        });
      });
    }

    manageModelsBtn.addEventListener('click', () => {
      apiSettingsModal.style.display = 'none';
      modelManagementModal.style.display = 'block';
      updateModelListDisplay();
    });

    cancelModelManagement.addEventListener('click', () => {
      modelManagementModal.style.display = 'none';
      apiSettingsModal.style.display = 'block';
      reloadCurrentModelSettings();
    });

    window.addEventListener('click', (event) => {
      if (event.target === modelManagementModal) {
        modelManagementModal.style.display = 'none';
        apiSettingsModal.style.display = 'block';
        reloadCurrentModelSettings();
      }
    });

    // æ·»åŠ æ–°ç‰ˆæœ¬
    addVersionBtn.addEventListener('click', () => {
      const selectedModelId = modelSelector.value;
      const newVersionValue = document.getElementById('newVersionValue').value.trim();
      const newVersionText = document.getElementById('newVersionText').value.trim();

      if (!selectedModelId || !newVersionValue || !newVersionText) {
        showMessage('è¯·é€‰æ‹©æ¨¡å‹å¹¶å¡«å†™ç‰ˆæœ¬ä¿¡æ¯', 'é”™è¯¯', 3000);
        return;
      }
      const model = currentModels.find(m => m.id === selectedModelId);
      if (!model) {
        showMessage('æœªæ‰¾åˆ°é€‰ä¸­çš„æ¨¡å‹', 'é”™è¯¯', 3000);
        return;
      }

      // ç¡®ä¿ç‰ˆæœ¬æ•°ç»„å­˜åœ¨
      if (!model.versions) {
        model.versions = [];
      }

      // æ£€æŸ¥é‡å¤
      if (model.versions.some(v => v.value === newVersionValue)) {
        showMessage('è¯¥æ¨¡å‹ä¸‹å·²å­˜åœ¨ç›¸åŒç‰ˆæœ¬å€¼', 'é”™è¯¯', 3000);
        return;
      }

      // æ·»åŠ æ–°ç‰ˆæœ¬
      model.versions.push({
        value: newVersionValue,
        text: newVersionText
      });

      document.getElementById('newVersionValue').value = '';
      document.getElementById('newVersionText').value = '';
      updateModelListDisplay();
    });

    saveModelsBtn.addEventListener('click', () => {
      localStorage.setItem('aiModels', JSON.stringify(currentModels));
      updateModelSelectors();

      modelManagementModal.style.display = 'none';
      apiSettingsModal.style.display = 'block';
      updateCurrentModelDisplay();
      reloadCurrentModelSettings();
    });

    resetModelsBtn.addEventListener('click', async () => {
      const result = await showConfirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æ¨¡å‹é…ç½®å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚');
      if (result) {
        currentModels = JSON.parse(JSON.stringify(defaultModels)); // æ·±æ‹·è´é»˜è®¤é…ç½®
        localStorage.setItem('aiModels', JSON.stringify(defaultModels));
        updateModelListDisplay();
        updateModelSelectors();
        updateCurrentModelDisplay();
        showMessage('å·²æ¢å¤é»˜è®¤é…ç½®', 'æˆåŠŸ', 2000);
      }
    });

    function reloadCurrentModelSettings() {
      const savedSettings = getSavedApiSettings();
      if (savedSettings) {
        aiModelSelect.value = savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini');
        updateModelVersions(savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini'));
        modelVersionSelect.value = savedSettings.version || '';
      } else {
        const defaultModel = currentModels.length > 0 ? currentModels[0].id : 'gemini';
        aiModelSelect.value = defaultModel;
        updateModelVersions(defaultModel);
        if (modelVersionSelect.options.length > 0) {
          modelVersionSelect.selectedIndex = 0;
        }
      }
    };
    initModels();
    updateCurrentModelDisplay();
  </script>
  <footer
    style="text-align: center; padding: 20px; margin-top: 40px; border-top: 1px solid #eee; color: #666; font-size: 14px;">
    <p>å…è´£å£°æ˜ï¼šæœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œé€šè¿‡åˆ†æç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ç”ŸæˆAIç»˜ç”»æç¤ºè¯ã€‚è¯·å‹¿ä¸Šä¼ åŒ…å«ç‰ˆæƒä¿æŠ¤çš„ä½œå“æˆ–ä»–äººåˆ›ä½œçš„å›¾åƒï¼Œé¿å…å¯èƒ½çš„ç‰ˆæƒäº‰è®®ã€‚</p>
    <p>æœ¬é¡¹ç›®ä¸å¯¹ç”Ÿæˆçš„æç¤ºè¯å†…å®¹è´Ÿè´£ï¼Œç”¨æˆ·åº”è‡ªè¡Œåˆ¤æ–­å’Œæ‰¿æ‹…ä½¿ç”¨é£é™©ã€‚å¦‚æ¶‰åŠç¬¬ä¸‰æ–¹çŸ¥è¯†äº§æƒï¼Œè¯·ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…è´£ä»»ã€‚</p>
  </footer>
</body>

</html>