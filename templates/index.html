<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»˜ç”»æç¤ºè¯ç”Ÿæˆå™¨</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body>
  <header>
    <h1>PROMPTOON</h1>
    <p class="subtitle">ä¸Šä¼ äºŒæ¬¡å…ƒ/åŠ¨æ¼«å›¾ç‰‡,è‡ªåŠ¨åæ¨ç”Ÿæˆ AI ç»˜ç”»æç¤ºè¯</p>
    <!-- å½“å‰æ¨¡å‹æ˜¾ç¤º -->
    <div class="current-model-display" id="currentModelDisplay">å½“å‰æ¨¡å‹: GEMINI (gemini-2.5-flash-lite)</div>
    <!-- APIè®¾ç½®æŒ‰é’® -->
    <div class="api-settings-btn" id="apiSettingsBtn">âš™ï¸</div>
  </header>

  <div class="container">
    <div class="main-layout" id="mainLayout">
      <div class="upload-section">
        <div class="upload-area" id="uploadArea">
          <div class="upload-content">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</div>
            <div class="upload-hint">æ”¯æŒ JPGã€PNGã€WebP æ ¼å¼</div>
          </div>
          <div class="preview-image-wrapper">
            <img id="previewImage" class="preview-image" alt="é¢„è§ˆå›¾ç‰‡">
          </div>
          <input type="file" id="fileInput" accept="image/*">
        </div>
        <button class="btn" id="generateBtn" disabled>ç”Ÿæˆæç¤ºè¯</button>
      </div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨åˆ†æå›¾ç‰‡å¹¶ç”Ÿæˆæç¤ºè¯...</p>
      </div>
      <!-- æ¶ˆæ¯å¼¹çª— -->
      <div class="message-modal" id="messageModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title" id="modalTitle">æç¤º</span>
          </div>
          <div class="modal-body">
            <p id="modalMessage"></p>
          </div>
        </div>
      </div>
      <!-- APIè®¾ç½®å¼¹çª— -->
      <div class="modal" id="apiSettingsModal">
        <div class="modal-content">
          <div class="modal-header">
            <span class="modal-title">APIè®¾ç½®</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="aiModel">AIæ¨¡å‹:
                <button id="manageModelsBtn" class="btn btn-secondary"
                  style="float: right; padding: 4px 8px; font-size: 0.8rem;">ç®¡ç†æ¨¡å‹</button>
              </label>
              <select id="aiModel" class="form-control">
                <option value="gemini">GEMINI</option>
                <option value="doubao">è±†åŒ…</option>
              </select>
            </div>

            <div class="form-group">
              <label for="modelVersion">æ¨¡å‹ç‰ˆæœ¬:</label>
              <select id="modelVersion" class="form-control">
              </select>
            </div>

            <div class="form-group">
              <label for="apiKey">API Key:</label>
              <input type="password" id="apiKey" class="form-control" placeholder="è¯·è¾“å…¥API Key">
            </div>

            <div class="form-actions">
              <button id="saveApiSettings" class="btn">ä¿å­˜</button>
              <button id="cancelApiSettings" class="btn btn-secondary">å–æ¶ˆ</button>
            </div>
          </div>
        </div>
      </div>

      <!-- æ¨¡å‹ç®¡ç†å¼¹çª— -->
      <div class="modal" id="modelManagementModal">
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <span class="modal-title">æ¨¡å‹ç®¡ç†</span>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>å½“å‰æ¨¡å‹åˆ—è¡¨:</label>
              <div id="modelListContainer">
                <!-- æ¨¡å‹åˆ—è¡¨ -->
              </div>
            </div>
            <div class="form-group">
              <label>ä¸ºé€‰ä¸­æ¨¡å‹æ·»åŠ ç‰ˆæœ¬:</label>
              <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <select id="modelSelector" class="form-control" style="flex: 1;">
                  <!-- æ¨¡å‹é€‰é¡¹ -->
                </select>
                <input type="text" id="newVersionValue" class="form-control"
                  placeholder="ç‰ˆæœ¬å€¼ (å¦‚: gemini-2.5-flash-lite)" style="flex: 1;">
                <input type="text" id="newVersionText" class="form-control" placeholder="ç‰ˆæœ¬æ˜¾ç¤ºæ–‡æœ¬" style="flex: 1;">
                <button id="addVersionBtn" class="model-btn">æ·»åŠ ç‰ˆæœ¬</button>
              </div>
            </div>

            <div class="form-actions">
              <button id="resetModelsBtn" class="btn btn-secondary">æ¢å¤é»˜è®¤</button>
              <button id="saveModelsBtn" class="btn">ä¿å­˜</button>
              <button id="cancelModelManagement" class="btn btn-secondary">å…³é—­</button>
            </div>
          </div>
        </div>
      </div>

      <div class="result-section" id="resultSection">
        <div class="tab-container">
          <div class="tab-buttons">
            <button class="tab-btn active" data-tab="cn">ä¸­æ–‡æç¤ºè¯</button>
            <button class="tab-btn" data-tab="en">English Prompt</button>
          </div>
          <div class="tab-content active" id="cnTab">
            <div class="prompt-card">
              <h3>
                ä¸­æ–‡æç¤ºè¯
              </h3>
              <div class="prompt-card-content" id="chinesePromptDetails"></div>
              <div class="full-prompt-box">
                <div class="prompt-label full">å®Œæ•´æè¿°</div>
                <textarea class="full-prompt-text" id="fullPromptCn"></textarea>
                <button class="copy-btn" onclick="copyFullPrompt('fullPromptCn', this)">å¤åˆ¶</button>
              </div>
            </div>
          </div>
          <div class="tab-content" id="enTab">
            <div class="prompt-card">
              <h3>
                English Prompt
              </h3>
              <div class="prompt-card-content" id="englishPromptDetails"></div>
              <div class="full-prompt-box">
                <div class="prompt-label full">å®Œæ•´æç¤ºè¯</div>
                <textarea class="full-prompt-text" id="fullPromptEn"></textarea>
                <button class="copy-btn" onclick="copyFullPrompt('fullPromptEn', this)">å¤åˆ¶</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ç¡®è®¤å¼¹çª— -->
    <div class="modal confirm-modal" id="confirmModal">
      <div class="confirm-modal-content">
        <div class="confirm-modal-body">
          <div class="confirm-modal-message" id="confirmMessage"></div>
          <div class="confirm-modal-actions">
            <button class="confirm-btn secondary" id="confirmCancel">å–æ¶ˆ</button>
            <button class="confirm-btn primary" id="confirmOk">ç¡®å®š</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const generateBtn = document.getElementById('generateBtn');
    const previewImage = document.getElementById('previewImage');
    const loading = document.getElementById('loading');
    const resultSection = document.getElementById('resultSection');
    const mainLayout = document.getElementById('mainLayout');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    let selectedFile = null;

    // Tabåˆ‡æ¢é€»è¾‘
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;

        // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        // æ¿€æ´»å½“å‰tab
        btn.classList.add('active');
        document.getElementById(`${tabId}Tab`).classList.add('active');
      });
    });

    // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
    uploadArea.addEventListener('click', () => fileInput.click());

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', (e) => {
      handleFile(e.target.files[0]);
    });

    // æ‹–æ‹½ä¸Šä¼ 
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFile(e.dataTransfer.files[0]);
    });

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFile(file) {
      if (!file || !file.type.startsWith('image/')) {
        showMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ Key', 'é”™è¯¯', 3000);
        return;
      }

      selectedFile = file;
      generateBtn.disabled = false;

      // é¢„è§ˆå›¾ç‰‡ - å›ºå®šé•¿å®½æ¯”å±•ç¤º
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        uploadArea.classList.add('has-image');
      };
      reader.readAsDataURL(file);
      resultSection.style.display = 'none';
      mainLayout.classList.remove('has-result');
    }

    // ç”Ÿæˆæç¤ºè¯
    generateBtn.addEventListener('click', async () => {
      if (!selectedFile) return;

      // è·å–ä¿å­˜çš„APIè®¾ç½®
      const apiSettings = getSavedApiSettings();
      if (!apiSettings) {
        showMessage('è¯·å…ˆè®¾ç½®API Key', 'é”™è¯¯', 3000);
        return;
      }

      const formData = new FormData();
      formData.append('image', selectedFile);

      // æ·»åŠ APIé…ç½®åˆ°è¯·æ±‚ä¸­
      formData.append('api_model', apiSettings.model);
      formData.append('model_version', apiSettings.version);
      // è§£å¯†API Keyå†å‘é€
      const decryptedApiKey = atob(apiSettings.apiKey);
      formData.append('api_key', decryptedApiKey);

      loading.style.display = 'block';
      resultSection.style.display = 'none';
      generateBtn.disabled = true;
      try {
        const response = await fetch('/generate_prompt', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          // åˆ‡æ¢åˆ°å·¦å³å¸ƒå±€
          mainLayout.classList.add('has-result');
          displayResults(data.prompt_data);
        } else {
          showMessage(data.error || 'ç”Ÿæˆå¤±è´¥,è¯·é‡è¯•', 'é”™è¯¯', 3000);
        }
      } catch (error) {
        showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'é”™è¯¯', 3000);
      } finally {
        loading.style.display = 'none';
        generateBtn.disabled = false;
      }
    });

    // å±•ç¤ºç”Ÿæˆç»“æœ
    function displayResults(promptData) {
      // å¦‚æœæ˜¯åŸå§‹å“åº”æ ¼å¼
      if (promptData.raw_response) {
        showMessage('AI è¿”å›æ ¼å¼å¼‚å¸¸,è¯·é‡è¯•', 'é”™è¯¯', 3000);
        return;
      }

      // æ˜¾ç¤ºè‹±æ–‡æç¤ºè¯è¯¦æƒ…
      const enDetails = document.getElementById('englishPromptDetails');
      enDetails.innerHTML = generatePromptFields(promptData.english_prompt, 'en');

      // æ˜¾ç¤ºä¸­æ–‡æç¤ºè¯è¯¦æƒ…
      const cnDetails = document.getElementById('chinesePromptDetails');
      cnDetails.innerHTML = generatePromptFields(promptData.chinese_prompt, 'cn');

      // æ˜¾ç¤ºå®Œæ•´æç¤ºè¯
      document.getElementById('fullPromptEn').value = promptData.full_prompt_en || '';
      document.getElementById('fullPromptCn').value = promptData.full_prompt_cn || '';

      resultSection.style.display = 'block';
    }

    // ç”Ÿæˆæç¤ºè¯å­—æ®µï¼ˆå¯ç¼–è¾‘+å¯å¤åˆ¶ï¼‰
    function generatePromptFields(promptObj, lang) {
      const fieldLabels = {
        'style_medium': lang === 'cn' ? 'é£æ ¼ä¸åª’ä»‹' : 'Style & Medium',
        'style_details': lang === 'cn' ? 'é£æ ¼ç»†èŠ‚' : 'Style Details',
        'scene': lang === 'cn' ? 'åœºæ™¯æè¿°' : 'Scene Description',
        'subject': lang === 'cn' ? 'ä¸»ä½“è§’è‰²' : 'Main Subject',
        'outfit_props': lang === 'cn' ? 'æœè£…é“å…·' : 'Outfit & Props',
        'background': lang === 'cn' ? 'èƒŒæ™¯' : 'Background',
        'composition': lang === 'cn' ? 'æ„å›¾è§†è§’' : 'Composition & Perspective',
        'lighting_color': lang === 'cn' ? 'å…‰ç…§è‰²è°ƒ' : 'Lighting & Color',
        'special_effects': lang === 'cn' ? 'ç‰¹æ®Šæ•ˆæœ' : 'Special Effects',
        'avoid': lang === 'cn' ? 'é¿å…å…ƒç´ ' : 'Avoid Elements'
      };

      let html = '';
      for (const [key, label] of Object.entries(fieldLabels)) {
        if (promptObj[key]) {
          html += `
            <div class="prompt-field">
              <span class="prompt-label">${label}</span>
              <div class="prompt-value">${promptObj[key]}</div>
            </div>
          `;
        }
      }
      return html;
    }
    // å¤åˆ¶å®Œæ•´æç¤ºè¯
    function copyFullPrompt(elementId, button) {
      const text = document.getElementById(elementId).value;

      navigator.clipboard.writeText(text).then(() => {
        const originalText = button.textContent;
        button.textContent = 'âœ“ å·²å¤åˆ¶';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        showMessage('å¤åˆ¶å¤±è´¥: ' + err.message, 'é”™è¯¯', 3000);
      });
    }
    // ç¡®è®¤å¼¹çª—å‡½æ•°
    function showConfirm(message) {
      return new Promise((resolve) => {
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmOk = document.getElementById('confirmOk');
        const confirmCancel = document.getElementById('confirmCancel');

        confirmMessage.textContent = message;
        confirmModal.style.display = 'block';

        const handleResult = (result) => {
          confirmModal.style.display = 'none';
          resolve(result);
          confirmOk.removeEventListener('click', handleOk);
          confirmCancel.removeEventListener('click', handleCancel);
        };

        const handleOk = () => handleResult(true);
        const handleCancel = () => handleResult(false);

        confirmOk.addEventListener('click', handleOk);
        confirmCancel.addEventListener('click', handleCancel);
      });
    }
    // æ¶ˆæ¯å¼¹çª—
    function showMessage(message, title = 'æç¤º', duration = 3000) {
      const modal = document.getElementById('messageModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');

      modalTitle.textContent = title;
      modalMessage.textContent = message;

      modal.style.display = 'block';

      // è‡ªåŠ¨å…³é—­
      setTimeout(() => {
        modal.style.display = 'none';
      }, duration);
    }
    const apiSettingsBtn = document.getElementById('apiSettingsBtn');
    const apiSettingsModal = document.getElementById('apiSettingsModal');
    const cancelApiSettings = document.getElementById('cancelApiSettings');
    const aiModelSelect = document.getElementById('aiModel');
    const modelVersionSelect = document.getElementById('modelVersion');
    const saveApiSettings = document.getElementById('saveApiSettings');

    const modelVersions = {
      gemini: [
        { value: 'gemini-2.5-flash-lite', text: 'gemini-2.5-flash-lite' },
        { value: 'gemini-3.0-pro', text: 'gemini-3.0-pro' }
      ],
      doubao: [
        { value: 'Doubao-Seed-1.8', text: 'Doubao-Seed-1.8' },
        { value: 'Doubao-Seed-1.6', text: 'Doubao-Seed-1.6' },
        { value: 'Doubao-Seed-1.6-flash', text: 'Doubao-Seed-1.6-flash' }
      ]
    };
    // æ‰“å¼€API
    apiSettingsBtn.addEventListener('click', () => {
      // åŠ è½½å·²ä¿å­˜
      const savedSettings = getSavedApiSettings();
      if (savedSettings) {
        aiModelSelect.value = savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini');
        updateModelVersions(savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini'));
        modelVersionSelect.value = savedSettings.version || '';
      } else {
        const defaultModel = currentModels.length > 0 ? currentModels[0].id : 'gemini';
        aiModelSelect.value = defaultModel;
        updateModelVersions(defaultModel);
      }
      document.getElementById('apiKey').value = '';

      apiSettingsModal.style.display = 'block';
    });
    cancelApiSettings.addEventListener('click', () => {
      apiSettingsModal.style.display = 'none';
    });

    window.addEventListener('click', (event) => {
      if (event.target === apiSettingsModal) {
        apiSettingsModal.style.display = 'none';
      }
      if (event.target === messageModal) {
        messageModal.style.display = 'none';
      }
    });

    aiModelSelect.addEventListener('change', (e) => {
      updateModelVersions(e.target.value);
    });

    function updateModelVersions(model) {
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      modelVersionSelect.innerHTML = '';

      // è·å–å½“å‰æ¨¡å‹çš„ç‰ˆæœ¬
      let versions = [];
      const modelConfig = currentModels.find(m => m.id === model);
      if (modelConfig) {
        versions = modelConfig.versions;
      } else {
        // fallback
        versions = modelVersions[model] || [];
      }

      // æ·»åŠ æ–°é€‰é¡¹
      versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version.value;
        option.textContent = version.text;
        modelVersionSelect.appendChild(option);
      });

      // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
      if (versions.length > 0) {
        modelVersionSelect.selectedIndex = 0;
      }
    }
    // ä¿å­˜APIè®¾ç½®
    saveApiSettings.addEventListener('click', () => {
      const model = aiModelSelect.value;
      const version = modelVersionSelect.value;
      const apiKey = document.getElementById('apiKey').value;

      if (!model || !version) {
        showMessage('è¯·é€‰æ‹©AIæ¨¡å‹å’Œæ¨¡å‹ç‰ˆæœ¬', 'é”™è¯¯', 3000);
        return;
      }
      const settings = {
        model: model,
        version: version
      };
      if (apiKey) {
        const encryptedApiKey = btoa(apiKey); // ç®€å•çš„Base64åŠ å¯†ï¼Œå®é™…åº”ç”¨ä¸­åº”ä½¿ç”¨æ›´å¼ºçš„åŠ å¯†æ–¹æ³•
        settings.apiKey = encryptedApiKey;
      } else {
        const savedSettings = getSavedApiSettings();
        if (savedSettings && savedSettings.apiKey) {
          settings.apiKey = savedSettings.apiKey;
        }
      }

      localStorage.setItem('apiSettings', JSON.stringify(settings));
      updateCurrentModelDisplay();
      apiSettingsModal.style.display = 'none';
      showMessage('APIè®¾ç½®å·²ä¿å­˜', 'æˆåŠŸ', 2000);
    });
    function getSavedApiSettings() {
      const settingsStr = localStorage.getItem('apiSettings');
      if (settingsStr) {
        try {
          return JSON.parse(settingsStr);
        } catch (e) {
          console.error('è§£æAPIè®¾ç½®å¤±è´¥:', e);
          return null;
        }
      }
      return null;
    }

    // æ›´æ–°å½“å‰æ¨¡å‹æ˜¾ç¤º
    function updateCurrentModelDisplay() {
      const savedSettings = getSavedApiSettings();
      const currentModelDisplay = document.getElementById('currentModelDisplay');

      if (savedSettings) {
        // æ‰¾åˆ°å½“å‰æ¨¡å‹çš„åç§°
        const model = currentModels.find(m => m.id === savedSettings.model);
        const modelName = model ? model.name : savedSettings.model;

        // æ‰¾åˆ°å½“å‰ç‰ˆæœ¬çš„æ˜¾ç¤ºæ–‡æœ¬
        let versionText = savedSettings.version;
        if (model) {
          const version = model.versions.find(v => v.value === savedSettings.version);
          versionText = version ? version.text : savedSettings.version;
        }

        currentModelDisplay.textContent = `å½“å‰æ¨¡å‹: ${modelName} (${versionText})`;
      } else {
        // é»˜è®¤æ˜¾ç¤º
        const defaultModel = currentModels.length > 0 ? currentModels[0] : { name: 'GEMINI', id: 'gemini' };
        const defaultVersion = defaultModel.versions && defaultModel.versions.length > 0 ?
          defaultModel.versions[0].text : 'gemini-2.5-flash-lite';
        currentModelDisplay.textContent = `å½“å‰æ¨¡å‹: ${defaultModel.name} (${defaultVersion})`;
      }
    }

    // æ¨¡å‹ç®¡ç†åŠŸèƒ½
    const manageModelsBtn = document.getElementById('manageModelsBtn');
    const modelManagementModal = document.getElementById('modelManagementModal');
    const cancelModelManagement = document.getElementById('cancelModelManagement');
    const addVersionBtn = document.getElementById('addVersionBtn');
    const saveModelsBtn = document.getElementById('saveModelsBtn');
    const resetModelsBtn = document.getElementById('resetModelsBtn');
    const modelListContainer = document.getElementById('modelListContainer');
    const modelSelector = document.getElementById('modelSelector');

    // é»˜è®¤æ¨¡å‹é…ç½®
    const defaultModels = [
      {
        id: 'gemini',
        name: 'GEMINI',
        versions: [
          { value: 'gemini-2.5-flash-lite', text: 'gemini-2.5-flash-lite' },
          { value: 'gemini-3.0-pro', text: 'gemini-3.0-pro' }
        ]
      },
      {
        id: 'doubao',
        name: 'è±†åŒ…',
        versions: [
          { value: 'Doubao-Seed-1.8', text: 'Doubao-Seed-1.8' },
          { value: 'Doubao-Seed-1.6', text: 'Doubao-Seed-1.6' },
          { value: 'Doubao-Seed-1.6-flash', text: 'Doubao-Seed-1.6-flash' }
        ]
      }
    ];
    let currentModels = [];
    // åˆå§‹åŒ–
    function initModels() {
      const savedModels = localStorage.getItem('aiModels');
      if (savedModels) {
        try {
          currentModels = JSON.parse(savedModels);
        } catch (e) {
          console.error('è§£ææ¨¡å‹é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', e);
          currentModels = defaultModels;
        }
      } else {
        currentModels = defaultModels;
        localStorage.setItem('aiModels', JSON.stringify(defaultModels));
      }
      updateModelSelectors();
      updateCurrentModelDisplay();
    }

    // æ›´æ–°æ¨¡å‹
    function updateModelSelectors() {
      aiModelSelect.innerHTML = '';
      modelSelector.innerHTML = '';

      currentModels.forEach(model => {
        // æ›´æ–°ä¸»æ¨¡å‹é€‰æ‹©å™¨
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.name;
        aiModelSelect.appendChild(option);

        // æ›´æ–°æ¨¡å‹ç®¡ç†ä¸­çš„é€‰æ‹©å™¨
        const selectorOption = document.createElement('option');
        selectorOption.value = model.id;
        selectorOption.textContent = model.name;
        modelSelector.appendChild(selectorOption);
      });

      updateModelListDisplay();
    }
    function updateModelListDisplay() {
      modelListContainer.innerHTML = '';

      currentModels.forEach((model, modelIndex) => {
        const modelDiv = document.createElement('div');
        modelDiv.className = 'model-item';
        modelDiv.style.border = '1px solid #ddd';
        modelDiv.style.borderRadius = '8px';
        modelDiv.style.padding = '15px';
        modelDiv.style.marginBottom = '15px';
        modelDiv.style.backgroundColor = '#f9f9fb';

        modelDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0;">${model.name} (${model.id})</h4>
          </div>
          <div>
            <strong>ç‰ˆæœ¬åˆ—è¡¨:</strong>
            <ul id="versions-list-${modelIndex}" style="margin-top: 10px; padding-left: 20px;">
              ${model.versions.map((version, versionIndex) => `
                <li style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                  <span>${version.text} (${version.value})</span>
                  <button class="remove-version-btn btn btn-secondary" data-model-index="${modelIndex}" data-version-index="${versionIndex}" style="padding: 2px 6px; font-size: 0.7rem;">åˆ é™¤</button>
                </li>
              `).join('')}
            </ul>
          </div>
        `;

        modelListContainer.appendChild(modelDiv);
      });
      bindRemoveEvents();
    }
    function bindRemoveEvents() {
      document.querySelectorAll('.remove-model-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const modelIndex = parseInt(e.target.getAttribute('data-index'));
          if (confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ "${currentModels[modelIndex].name}" å—ï¼Ÿ`)) {
            currentModels.splice(modelIndex, 1);
            updateModelListDisplay();
            updateModelSelectors();
          }
        });
      });
      document.querySelectorAll('.remove-version-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const modelIndex = parseInt(e.target.getAttribute('data-model-index'));
          const versionIndex = parseInt(e.target.getAttribute('data-version-index'));
          const versionText = currentModels[modelIndex].versions[versionIndex].text;

          const result = await showConfirm(`ç¡®å®šè¦åˆ é™¤ç‰ˆæœ¬ "${versionText}" å—ï¼Ÿ`);
          if (result) {
            currentModels[modelIndex].versions.splice(versionIndex, 1);
            updateModelListDisplay();
          }
        });
      });
    }
    manageModelsBtn.addEventListener('click', () => {
      apiSettingsModal.style.display = 'none';
      modelManagementModal.style.display = 'block';
      updateModelListDisplay();
    });
    cancelModelManagement.addEventListener('click', () => {
      modelManagementModal.style.display = 'none';
      apiSettingsModal.style.display = 'block';
      reloadCurrentModelSettings();
    });

    window.addEventListener('click', (event) => {
      if (event.target === modelManagementModal) {
        modelManagementModal.style.display = 'none';
        apiSettingsModal.style.display = 'block';
        reloadCurrentModelSettings();
      }
    });

    // æ·»åŠ æ–°ç‰ˆæœ¬
    addVersionBtn.addEventListener('click', () => {
      const selectedModelId = modelSelector.value;
      const newVersionValue = document.getElementById('newVersionValue').value.trim();
      const newVersionText = document.getElementById('newVersionText').value.trim();

      if (!selectedModelId || !newVersionValue || !newVersionText) {
        showMessage('è¯·é€‰æ‹©æ¨¡å‹å¹¶å¡«å†™ç‰ˆæœ¬ä¿¡æ¯', 'é”™è¯¯', 3000);
        return;
      }
      const model = currentModels.find(m => m.id === selectedModelId);
      if (!model) {
        showMessage('æœªæ‰¾åˆ°é€‰ä¸­çš„æ¨¡å‹', 'é”™è¯¯', 3000);
        return;
      }

      // æ£€æŸ¥
      if (model.versions.some(v => v.value === newVersionValue)) {
        showMessage('è¯¥æ¨¡å‹ä¸‹å·²å­˜åœ¨ç›¸åŒç‰ˆæœ¬å€¼', 'é”™è¯¯', 3000);
        return;
      }

      // æ·»åŠ æ–°ç‰ˆæœ¬
      model.versions.push({
        value: newVersionValue,
        text: newVersionText
      });

      document.getElementById('newVersionValue').value = '';
      document.getElementById('newVersionText').value = '';
      updateModelListDisplay();
    });

    saveModelsBtn.addEventListener('click', () => {
      localStorage.setItem('aiModels', JSON.stringify(currentModels));
      const newModelVersions = {};
      currentModels.forEach(model => {
        newModelVersions[model.id] = model.versions;
      });
      Object.assign(modelVersions, newModelVersions);
      updateModelSelectors();

      modelManagementModal.style.display = 'none';
      apiSettingsModal.style.display = 'block';
      updateCurrentModelDisplay();
      reloadCurrentModelSettings();
    });
    resetModelsBtn.addEventListener('click', async () => {
      const result = await showConfirm('ç¡®å®šè¦æ¢å¤é»˜è®¤æ¨¡å‹é…ç½®å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬ã€‚');
      if (result) {
        currentModels = JSON.parse(JSON.stringify(defaultModels));
        updateModelListDisplay();
        updateModelSelectors();
        updateCurrentModelDisplay();
        showMessage('å·²æ¢å¤é»˜è®¤é…ç½®', 'æˆåŠŸ', 2000);
      }
    });
    function reloadCurrentModelSettings() {
      const savedSettings = getSavedApiSettings();
      if (savedSettings) {
        aiModelSelect.value = savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini');
        updateModelVersions(savedSettings.model || (currentModels.length > 0 ? currentModels[0].id : 'gemini'));
        modelVersionSelect.value = savedSettings.version || '';
      } else {
        const defaultModel = currentModels.length > 0 ? currentModels[0].id : 'gemini';
        aiModelSelect.value = defaultModel;
        updateModelVersions(defaultModel);
        if (modelVersionSelect.options.length > 0) {
          modelVersionSelect.selectedIndex = 0;
        }
      }
    };

    initModels();
    updateCurrentModelDisplay();
  </script>
</body>

</html>